name: Build & Deploy
on: workflow_dispatch

jobs:
  build:
    name: Build
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Setup .NET Core
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 6.0.x

      - name: Install dependencies
        run: dotnet restore
        working-directory: src

      - name: Build module
        run: | 
          $modulesDataPath = '../ModuleData';
          $subModuleXMLPath = '../SubModule.xml';
          $dllPath = $PWD.Path + '/bin/Release/net472/ROTFrench.dll';
          $pdbPath = $PWD.Path + '/bin/Release/net472/ROTFrench.pdb';
          $path = './build/ROTFrench/';
          dotnet build --configuration Release
          mkdir $path/bin/Win64_Shipping_Client/;
          mkdir $path/ModuleData/;
          Copy-Item $dllPath $path/bin/Win64_Shipping_Client/ROTFrench.dll;
          Copy-Item $dpdbPath $path/bin/Win64_Shipping_Client/ROTFrench.pdb;
          Copy-Item $modulesDataPath/* $path/ModuleData;
          Copy-Item $subModuleXMLPath $path/SubModule.xml;
        working-directory: src

      - name: Extract version
        id: version
        run:  |
          dotnet tool install -g Bannerlord.ChangelogParser
          vers="$(bannerlord_changelog_parser latestversion -f "$PWD/changelog.txt")"
          echo "::set-output name=mod_version::$vers"
          desc="$(bannerlord_changelog_parser fulldescription -f "$PWD/changelog.txt")"
          desc="${desc//'%'/'%25'}"
          desc="${desc//$'\n'/'%0A'}"
          desc="${desc//$'\r'/'%0D'}"
          echo "::set-output name=mod_description::$desc"
